<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USDT Transfer Listener</title>
    <script type="module">
        import { createPublicClient, webSocket } from 'https://esm.sh/viem';
        import { mainnet } from 'https://esm.sh/viem/chains';

        async function main() {
            // 创建以太坊主网的公共客户端
            const client = createPublicClient({
                chain: mainnet,
                transport: webSocket('wss://mainnet.infura.io/ws/v3/59d76783bf2a4c9e9e202e59876c075f')
            });

            // 监听新区块
            client.watchBlocks({
                onBlock: (block) => {
                    console.log(`Block Height: ${block.number}, Hash: ${block.hash}`);
                }
            });

            // 设置 USDT 合约地址和 Transfer 事件的 ABI
            const usdtAddress = '0xdac17f958d2ee523a2206206994597c13d831ec7';
            const transferEvent = {
                address: usdtAddress,
                eventName: 'Transfer',
                args: {
                    from: 'address',
                    to: 'address',
                    value: 'uint256'
                },
                eventHash: '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a116f5b4f242'
            };

            // 监听 Transfer 事件
            client.watchEvent({
                onLogs: (logs) => {
                    logs.forEach(log => {
                        if (log.args && log.args.from && log.args.to && log.args.value) {
                            const from = log.args.from;
                            const to = log.args.to;
                            const value = log.args.value / (10 ** 6); // 假设 USDT 6位小数
                            const blockNumber = log.blockNumber;
                            const txHash = log.transactionHash;

                            console.log(`In Block ${blockNumber} (${txHash}), USDT Transfer: ${from} -> ${to}, Amount: ${value} USDT`);
                        } else {
                            console.log("Skipped log with invalid args structure:", log);
                        }
                    });
                },
                filter: {
                    ...transferEvent
                }
            });
        }

        main();
    </script>
</head>
<body>
    <h1>USDT Transfer and New Block Listener</h1>
</body>
</html>
